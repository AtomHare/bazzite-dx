#!/bin/bash
set -euo pipefail

# Define Cursor CLI binary and options
CLI_BIN="/usr/bin/cursor-cli"
CLI_OPTIONS=(tunnel ext status version serve-web update help -h --help -V --version)

# Check if CLI binary exists and is executable
if [[ ! -x "$CLI_BIN" ]]; then
    echo "Error: $CLI_BIN not found or not executable." >&2
    exit 1
fi

# Check if AppImage from CLI exists and is executable
APPIMAGE=$("$CLI_BIN" version show | grep "Installation path:" | cut -d' ' -f3 || echo "")
if [[ -z "$APPIMAGE" ]]; then
    echo "Error: No AppImage configured." >&2
    exit 1
fi
if [[ ! -x "$APPIMAGE" ]]; then
    echo "Error: $APPIMAGE not found or not executable." >&2
    exit 1
fi

# Function to check if argument is a CLI option
is_cli_option() {
    for opt in "${CLI_OPTIONS[@]}"; do
        if [[ "$1" == "$opt" ]]; then
            return 0
        fi
    done
    return 1
}

# Function to check if AppImage is running
is_running() {
    pgrep -f "$APPIMAGE" >/dev/null
}

# Check if we need to run in background
if ! is_running || [[ $# -eq 0 ]] || ! is_cli_option "$1"; then
    "$CLI_BIN" "$@" &>/dev/null & disown
    exit 0
fi

"$CLI_BIN" "$@"
exit $?
